# Neolithic simulation

Agent-based simulation of interactions among groups of farmers and aggressors in a neolithic setting. This folder contains a Python version of the simulation variant with warfare (both stationary and roaming aggressors versions). Note that handling of stationary aggressors differs slightly from the [C++ version](../neolithic_cpp); to reproduce the results of our [preprint](https://osf.io/preprints/socarxiv/c32up), use that version of the simulation.

## 1. Requirements

It is assumed that all data is stored in the layout generated by the preprocessing scripts in a directory in the shell variable `$base_dir`. To run the simulation, the following Python libraries are required:
```
os, sys, math, struct, bisect, mmap, sortedcontainers, enum, numpy, 
```
Additionally, for video creation, the [Cairo](https://www.cairographics.org/) graphics libraries are used, available in the `cairo` Python package.


## 2. Create a distance and probability matrix

All following commands are assumed to be run under in the current directory.

To speed up the simulation, we first need to pre-compute distances and migration probabilities among all cells and save it to a binary matrix. The same matrix can be reused as long as the migration characteristic distances are the same. This step processes the input data, and results in a large binary file (currently 6.2 GiB) that is used in the following. Currently, this takes a significnat amount of time (up to 1-2 hours). Since the format of this file is compatible with the [C++ code](../neolithic_cpp), faster processing can be achieved by creating these using `cm` program from there.

The following command creates this matrix with some typical parameters (80 km characteristic distance, 10x faster travel along the Mediterranean coast):

```
python3 nwrun1.py -M -H $base_dir/simulation/matrix_dg_G80zC10.bin -z -K 150 -Kt 50 -cc $base_dir/gaez_crop/eu_dggrid_coords_K_land4a.csv -ct -n $base_dir/dggrid/isea3h12eun.nbr -nr -nC 0.1 -nE $base_dir/eu_dggrid_extra_edges.dat -G 80 -Ks $base_dir/gaez_crop/eu_dggrid_land_share.csv
```

This will create the output file `matrix_dg_G80zC10.bin` (under the `simulation` subdirectory of the main data directory). Main parameters are `-M` (specifies that a binary matrix is created instead of running the simulation), `-G` (characteristic distance of migrations, in kms), `-nC` (travel speed improvement along coastal cells) and `-K` (required average carrying capacity of cells -- carrying capacities are readjusted to match this). Detailed description of parameters and options are given below.

Notes:
- It is possible to run the simulation without creating this matrix first (i.e. creating everything in memory only), but this is not recommended since most of the runtime will be spent on recalculating distances and probabilities instead of doing the actual simulation.
- The binary matrix format is the same as created and used by the [C++ version](../neolithic_cpp) of this simulation. The actual matrices are not the same, since the order of nodes can be different and there are also numerical differences.
- When running multiple instances / realizations of the simulation in parallel, they will automatically use shared memory for loading this matrix. This way, the memory requirement for the matrix is only counted once.


## 3. Run the simulation

The following is an example of running the simulation with typical parameters, but without taking into account climate-based variation in agricultural productivities:
```
python3 nwrun1.py -H $base_dir/simulation/matrix_dg_G80zC10.bin -Rr -Rp 1 -RP -RA 0.25 -R 8 -Rs 0 -m -d 1 -s 1 -S 5000 -E 100 -a 1.0 -i 1596250 -I 5000 -If 0.5 -Ip 0.5 -Ce 0 -Cb 0 -De 1 -Dm 0.5 -Db 0.25 -Dl 200 -o $base_dir/simulation/run1sp.out -op 10 > $base_dir/simulation/run1.out
```

This results in two output files:
 - `run1.out` (written to stdout): TSV file of summary data with the following columns: simulation year, number of farmer cells, farmer population, aggressor cells and aggressor population
 - `run1sp.out` (specified with the `-o` parameter): TSV file with the population and type of each non-empty cell (by default written every 10 years) 

Main parameters include the number of steps (years) the simulation should run for (`-S`), the characteristic distance of aggressor attacks (`-R`; in kms), the preference for split-off groups for selecting an empty cell (`-E`; this is the inverse of the p_E parameter in the paper), the frequency of attacks by aggressors (`-RA`; in 1 / years), chance of an attack being successful (`-a`), the flag specifying mobile aggressors (`-m`), detailed output file name (`-o`) and output frequency (`-op`) and the random seed used (`-s`). Detailed description of all parameters are given below.


Alternative example with the stationary aggressors model:
```
python3 nwrun1.py -H $base_dir/simulation/matrix_dg_G80zC10.bin -Rr -R2 -Rc -Rp 1 -RP -RA 0.25 -R 8 -Rs 0 -d 1 -s 1 -S 5000 -E 100 -a 0.5 -o $base_dir/simulation/run2sp.out -op 10 -i 1596250 -I 5000 -If 0.5 -Ip 0.5 -Ce 0 -Cb 0 -De 1 -Dm 0.5 -Db 0.25 -Dl 200 > $base_dir/simulation/run2.out
```

(main differences: removal of the `-m` parameter, addition of the `-R2` and `-Rc` parameters, and setting `-a 0.5`)


### 3.1. Climatic variability

Including the effect of climate variation on yields can be done as shown in the following example:
```
python3 nwrun1.py -H $base_dir/simulation/matrix_dg_G80zC10.bin -Rr -R2 -Rc -Rp 1 -RP -RA 0.25 -R 8 -Rs 0 -d 1 -s 1 -S 5000 -E 100 -a 0.5 -o $base_dir/simulation/run3sp.out -op 10 -i 1596250 -I 5000 -If 0.5 -Ip 0.5 -Ce 0 -Cb 0 -De 1 -Dm 0.5 -Db 0.25 -Dl 200 -w $base_dir/climate/cell_ids_dggrid.csv $base_dir/climate/crop_data_cmb.dat -wm -wC -wf -wF -7000 -ws 1 > $base_dir/simulation/run3.out
```
This example is for the stationary aggressors model, but this can be used for the other model versions in a similar way as well. Main parameters include the location of the additional input files (`-w`, assumed to be in the `climate` directory in the base location for data files), the simulation start year (`-wF`, in absolute terms, in this case 7000 BCE), and the relative scale of yield variability (`-ws`). Detailed description of the command line arguments is given below.



## 4. Video creation

The separate program, `sp2png.py` can be used to convert the detailed output of the simulation to a series of images that can then be joined together as a video. This requires the [Cairo graphics](https://www.cairographics.org/) libraries to be installed.

Example run:
```
mkdir $base_dir/simulation/figs
python3 sp2png.py -w 1608 -h 900 -o $base_dir/simulation/figs/run1 -fc $base_dir/gaez_crop/eu_dggrid_coords_K_land4a.csv -p $base_dir/dggrid/dggrid_poly.csv -m 208 < $base_dir/simulation/run1sp.out
```
This creates a series of PNG images under `figs`. These can be joined together as a video, for example with [ffmpeg](https://ffmpeg.org/), using the following command:
```
ffmpeg -r 24 -pattern_type glob -i $base_dir/simulation/figs/run1_\*.png -codec:v h264 -crf 15 $base_dir/simulation/run1.mkv
```

Alternatively, the above code can write raw image data to its standard output that can be piped directly to `ffmpeg` (and potentially to other video encoders as well):
```
python3 sp2png.py -w 1608 -h 900 -o - -fc $base_dir/gaez_crop/eu_dggrid_coords_K_land4a.csv -p $base_dir/dggrid/dggrid_poly.csv -m 208 < $base_dir/simulation/run1sp.out | ffmpeg -y -f rawvideo -pix_fmt bgra -s 1608x900 -r 24 -i - -codec:v h264 -crf 15 $base_dir/simulation/run12.mkv
```

Main parameters include the output image size (`-w` and `-h`), the output base file name (`-o`; using `-` means writing to stdout in raw format; otherwise, PNG images are created) and the expected maximum population in a cell (`-m`; this needs to be given to appropriately scale the color scale in the output). See a detailed description of command line options below.


## 5. Simulation variant without conflict

It is possible to turn off the conflict component in the simulation, resulting in the spread of farmers only affected by climate. This includes three changes: (1) ensuring that only empty cells are selected for migration targets; (2) updating the target distributions when cells are settled to allow this; (3) limiting the migration probability distributions with a realistic maximum distance (otherwise, longer, unrealistic migrations would be selected). This is achieved by the flags `-l`, `-H1` and `-L` respectively. Options related to conflict can be omitted. A typical run of the simulation would then be the following (for a characteristic distance of 40 km):

```
python3 nwrun1.py -H1 $base_dir/simulation/matrix_dg_G40zC10.bin -G 40 -l -L -d 1 -s 1 -S 3000 -o $base_dir/simulation/run4sp.out -op 10 -i 1596250 -I 100000 -If 0.5 -Ip 1 -Ce 0 -Cb 0 -De 1 -Dm 0.5 -Db 0.25 -Dl 200 > $base_dir/simulation/run4.out
```


## 6. Command line options

The main script (`nwrun1.py`) has two modes of operation. If the `-M` parameter is given on the command line, it will create a binary matrix of migration probabilities and optionally distances. Without the `-M` parameter, it will run the simulation. In this case, it can either read a previously created binary matrix if it is given by the `-H` parameter, or read all the input files and re-create it before running. Most command line options should be compatible with the [C++ version](../neolithic_cpp) of the simulation (`create_helper_matrix.cpp` and `neolithic2w.cpp`).

### Input files

 - `-c fn` or `-cc fn` name of the file with a list of cell IDs, coordinates and (optionally) base carrying capacities and cell types; by default, this file is expected in a TSV format without header; use the `-cc` form if the input is a CSV with header
 - `-k` has to be given if the above file contains carrying capacities (e.g. GAEZ base estimates); otherwise a constant value is assumed (note: this is used in all cases in the examples, probably should be the default)
 - `-ct` should be given if the above tile contains cell "types", an additional integer column; currently, only two types are supported: land cells (0) and coastal cells (1). In the input files, I have marked any cell that is on the Mediterranean coast as coastal.
 - `-n fn` or `-ne fn` name of the file containing the neighbor relations among cells; use `-n` if this file is in the DGGRID output format (all neighbors of a cell are listed on a line), and the `-ne` variant if this file is an edgelist (each line contains two node IDs); the input file should be symmetric, i.e. it should contain all edges both ways
 - `-nC num` scaling factor for travel distance between coastal cells; calculated distance is multiplied by this, so giving a number < 1 allows faster / further travel along coastal cells
 - `-nE fn` name of a file containing additional edges (as an edgelist) that should be added to the cell neighbor relations; this is currently used to add links between non-adjacent cells
 - `-nr` if given, distances are calculate along neighbor edges taking into account any scaling factor (this should probably be the default)
 - `-z` calculate distances along shortest paths in the cell network, taking into account any scaling, and store a matrix of such distances in the output
 - `-K num` scale carrying capacities so that the average capacity of a cell is the value given here (recommended to use, since the input files contain arbitrary values)
 - `-Kg` additionally scale the capacity in each cell by the cosine of the latitude (to account for a case when cells' size depends on the latitude as is the case of a rectangular grid; this is not used with DGGRID)
 - `-Ks fn` read additional scaling factors for each cell from the given file (this is used for taking into account the share of actual usable soil in each cell); this option can be used multiple times, resulting in the product of all scaling factors used
 - `-G dist` characteristic distance used in the migration probabilities (exponential decay)
 - `-H fn` or `-H1 fn` name of the binary file containing the pre-computed probability distributions; if given, only the `-K` option can be present from the above; if the latter form (`-H1`) is used, only the distances are used, the migration distributions are recalculated as needed (and thus can change during the simulation run; in this case, a `-G` parameter can be given independently from what was used when creating the binary file)
 - `-L` if given, instead of a global probability distribution for migrations, only consider targets up to a maximum distance that is 10 times the characteristic distance given by `-G`
 - `-M` instead of running a simulation, create the helper file with pre-computed migration probabilities and save it to the file name given by `-H`
  
Notes: by default, distance among two cells is just the straight line (great circle) distance among their center points. If the `-z` option is given, a distance matrix is created along shortest paths. This is recommended to handle the case of barriers (e.g. oceans) and the possibility of faster travel along some routes (such as the coastal travel in the Mediterranean). Typical results in the paper draft use a setting of `-nC 0.1`, i.e. travel along the coast is considered 10 times faster than overland. Note that in practice, the simulation everywhere uses "scaled distances", i.e. as if the distance between coastal cells was shorter, according to the factor given with this option. Additionally, it is possible to add extra links (between cells that are not actually neighbors): I use this to allow travel across the Aegean and the Adriatic (note: normally, cells in the sea are not included in the simulation space, so seas would be barriers).


### Weather data input

Climate data was used to prepare a set of relative variations in agricultural productivity. This estimation was done in spatial units distinct from the hexagons used in the simulation (essentially a rectangular grid; referred to in the following as "weather cells"). The dataset contains two files: `crop_data_cmb.dat` contains the relative variation of agricultural productivity in the weather cells for the 7,500-year period between -8,050 and -550 BCE; `cell_ids_dggrid.csv` contains the overlap between weather cells and DGGRID hexagons. Both need to be used when running the simulation.

The following command line options are supported:

 - `-w fn1 fn2` specifies the names of two files with the data to use; `fn1` should be the mapping between weather cells and simulation cells (i.e. `cell_ids_dggrid.csv` in this case), `fn2` should be the file with the actual variations (`crop_data_cmb.dat` in this case)
 - `-wm` if given, missing cells are allowed; without this, every cell has to appear in all years in the input file
 - `-wc` if given, cut the simulation area to cells that have climatic variation data
 - `-wf` if given, the mapping between weather cells and simulation cells contains weighting factors; this means that multiple weather cells overlap with one simulation cell and a weighted average is used to calculate any actual effect of climate variation; this option is necessary when using the hexagon grid (maybe this should be made the default)
 - `-wC` if given the mapping file is in CSV format (this is necessary for the above files)
 - `-wF year` if given, assume that the start year of the simulation is the one given here (as an absolute number, in calendar years, i.e. BCE / CE); data before this date in the input file is skipped; if not given, the first year is the input file is assumed to be the beginning of the simulation
 - `-ws factor` scale any variation in yield by this factor; this can be used to exaggerate the effect of climatic variability
 

### Initial condition and basic settings

 - `-i ID` ID of the cell where to place a starting population (a location in Anatolia is used in the examples, with cell ID 1596250)
 - `-I pop` size of the starting population to use (default: 100); if this is larger than the carrying capacity of the starting cell, the additional population is distributed in neighboring cells
 - `-If factor` when distributing the initial population, cells are only filled up to this factor (e.g. 0.5); this option is useful to avoid an initial "explosion" of migrations that would happen if the initial conditions include cells close to their carrying capacity
 - `-Ip factor` when distributing the initial population, any neighbor cell is chosen with this probability (e.g. 0.5); this can be used to start from a less tightly packed configuration of occupied cells
 - `-S n` number of steps (years) to run the simulation for
 - `-o fn` detailed output filename; the population in each cell is written here every regularly
 - `-op num` write detailed output to the above file every `num` years (default: every 10 years)
 - `-s num` number to use to seed the random number generator (current time is used by default)
 - `-r r` base population growth rate (per year)
 - `-d r` population collapse factor (if population is above carrying capacity, it collapses to this ratio of it; I use 1 in recent simulations to simplify things, but values below one can model a larger collapse)


### Farmers' dynamics
 - `-E num` preference to choose an empty cell for group migrations (typical value: 10, default value is 1); i.e. a larger value will result in less aggressors to be created until the landscape is more saturated
 - `-l` only empty cells can be chosen as migration targets (no aggressors will by created)
 - `-Dl num` Dunbar number to use (default: 150)
 - `-Db p` probability of a group splitting off if the population of a cell is equal to the Dunbar number
 - `-Dm r` minimum ratio of population to the Dunbar number to consider a possibility of split-off
 - `-De e` exponent used to calculate the probability of split-off due to approaching the Dunbar limit
 - `-Cb p` probability of a group splitting off if the population of a cell is equal to the currnt local carrying capacity
 - `-Cm r` minimum ratio of population to the carrying capacity to consider a possibility of split-off
 - `-Ce e` exponent used to calculate the probability of split-off due to approaching the carrying capacity limit

Note: each year, the possiblity of a group splitting off (and migrating elsewhere) is considered for each cell. This is done by first estimating a probability for this to happen based on the Dunbar limit and carrying capacity limit. In each case, this is done in the following way:
```
P = p * ((x - r) / (1 - r))**e
```
where `x` is the current population relative to the limit considered (either the Dunbar number, given by the `-Dl` parameter, or the local carrying capacity), and `p`, `r` and `e` are the parameters given above. By default, both mechanisms are considered, and a migration occurs if either of them yields it by random choice (given the probability computed as above). Setting the `-Db` or `-Cb` value to zero disables that mechanism.

Note: in all simulations for the paper, we've used the estimation based on the Dunbar-limit, and did not consider the carrying capacity based choices. These were however implemented as options for additional exploration of dynamics.


### Aggressors' dynamics

 - `-R dist` characteristic distance in the probability of choosing a target for aggressors (this can be varied independently from the migration probability distribution parameter; this uses an exponential scaling as well)
 - `-Rc` if a cell is succesfully defended from an attack, it turns into aggressors with a probability of 50% or the number given below
 - `-Rp prob` probability of defenders turning to aggressors if succesful and probability of a migrating group turning to aggressors when targeting an already settled cell (default: 50%)
 - `-Rr` if given, aggressors cannot revert back to farmers (they die out instead if they cannot find a target and win; this leaves their cell empty)
 - `-RR r` rate (i.e. yearly probability) of a aggressor cell reverting back to farmers (independently of any other interaction; default: 0)
 - `-RP` if given, aggressors take into account the current farmer population when choosing a target (they prefer cells with larger populations)
 - `-Rm dist` maximum distance that aggressors are able to attack (default is 10x the distance given by the `-R` option)
 - `-m` aggressors are considered mobile: after each successful attack, they move to the attacked cell
 - `-a prob` probability of an attack (by aggressors) being successful (e.g. setting this to 1 means that aggressors always win)
 - `-RA r` attack rate (per year) of aggressors; if this is < 1, aggressors do not attack every year, they can stay idle
 - `-R2` use the new model of stationary aggressors (with "exponential" growth); in this case, aggressors do not revert back to farming (or die) if they are defeated; used in combination with the `-Rc` parameter, the number of aggressors can quickly grow in an area
 
Note: the two combinations that are used in the paper are the following (shown only the differences):
 - "roaming aggressors": `-m -a 1.0`
 - "stationary aggressors": `-R2 -a 0.5 -Rc`
Both cases include the following parameters: `-Rr -Rp 1.0 -RP -R 8`; furthermore, additional parameters are varied independently of these: `-E`, `-RA`

 
### Command line options of `sp2png.py`

 - `-p fn` filename of the polygons that correspond to the cell IDs used in the input; this should be a csv file containing the ID and the coordinates in an order that can be used for drawing
 - `-f fn` or `-fc fn` optionally a file that contains a list of cell IDs used in the simulation; this should be a subset of the cell IDs in the above file and can be used to limit the spatial extent of the output (the second form should be used if this file is in a CSV format)
 - `-o fn` base filename of output, the current year is appended to it; if `fn` is `-`, output is written on the standard output in a raw RGBA format (that can be piped to a video encoder directly)
 - `-w width` width of output images
 - `-h height` height of output images
 - `-g` if given, scale the output based on the center latitude of the cells instead of streching it to fit the width / height
 - `-G num` gamma correction exponent to apply to the output
 - `-m num` maximum population value expected on the input; values larger than this are saturated



